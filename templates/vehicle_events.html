{% extends "base.html" %}
{% block content %}
<h2>Events for {{ asset_name }}{% if event_type %} ({{ event_type }}){% endif %}</h2>

<p>Total events: {{ events|length }}</p>

<!-- Loading placeholder -->
<div id="loadingMessage">Loading events...</div>

<div class="events-container" style="display:none;">
    <!-- Table container -->
    <div class="events-table-container">
        <table id="eventsTable">
            <thead>
                <tr>
                    <th>Event Type</th>
                    <th>Date</th>
                    <th>Location</th>
                    <th>Battery Voltage</th>
                    <th>Power Voltage</th>
                </tr>
            </thead>
            <tbody>
                {% for e in events %}
                <tr data-lat="{{ e.Latitude }}" data-lon="{{ e.Longitude }}"
                    data-details="Type: {{ e.EventTypes }} | Date: {{ e.EventDate }} | Location: {{ e.LocationAddress }} | Battery: {{ e.BatteryVoltage }} | Power: {{ e.PowerVoltage }}"
                    data-google="https://www.google.com/maps?q={{ e.Latitude }},{{ e.Longitude }}">
                    <td>{{ e.EventTypes }}</td>
                    <td>{{ e.EventDate }}</td>
                    <td>{{ e.LocationAddress }}</td>
                    <td>{{ e.BatteryVoltage }}</td>
                    <td>{{ e.PowerVoltage }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Map container -->
    <div id="map" class="events-map"></div>
</div>

<a class="btn-back" href="{{ url_for('vehicle.vehicle_dashboard') }}">Back to Dashboard</a>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
/* === Layout === */
.events-container { display: flex; gap: 20px; height: 500px; }
.events-table-container { flex: 1; overflow-y: auto; border: 1px solid #ccc; }
.events-map { flex: 1; }

/* === Table styling === */
#eventsTable { width: 100%; border-collapse: collapse; }
#eventsTable th, #eventsTable td { padding: 8px; border: 1px solid #ddd; }
#eventsTable thead { position: sticky; top: 0; background-color: #f2f2f2; z-index: 1; }
#eventsTable tbody tr { cursor: pointer; }
#eventsTable tbody tr.selected { background-color: #ffe066; }

/* === Leaflet Popup === */
.leaflet-popup-content-wrapper { background-color: #007bff !important; color: #fff !important; border-radius: 5px; font-size: 14px; padding: 8px; }
.leaflet-popup-tip { background-color: #007bff !important; }
.leaflet-popup-content { color: #fff !important; }

/* === Back button === */
.btn-back { display: inline-block; margin-top: 15px; padding: 6px 12px; background-color: #0066cc; color: #fff; text-decoration: none; border-radius: 4px; }
.btn-back:hover { background-color: #004c99; }

#loadingMessage { font-size: 16px; margin-bottom: 10px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Show container and hide loading
    document.getElementById('loadingMessage').style.display = 'none';
    document.querySelector('.events-container').style.display = 'flex';

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let allMarkers = [];
    let currentMarker = null;
    let selectedRow = null;

    document.querySelectorAll('#eventsTable tbody tr').forEach(row => {
        const lat = parseFloat(row.dataset.lat);
        const lon = parseFloat(row.dataset.lon);
        const googleUrl = row.dataset.google;

        const parts = row.dataset.details.split(' | ');
        const htmlDetails = parts.map(part => {
            const idx = part.indexOf(':');
            return idx > -1 ? `<b>${part.substring(0, idx)}:</b>${part.substring(idx + 1)}` : part;
        }).join('<br>');

        const marker = L.marker([lat, lon]).addTo(map).bindPopup(htmlDetails, { maxWidth: 300 });
        allMarkers.push(marker);

        row.addEventListener('click', () => {
            if (currentMarker) map.removeLayer(currentMarker);

            currentMarker = L.marker([lat, lon]).addTo(map).bindPopup(htmlDetails, { maxWidth: 300 }).openPopup();
            map.setView([lat, lon], 15);

            if (selectedRow) selectedRow.classList.remove('selected');
            row.classList.add('selected');
            selectedRow = row;
        });

        row.addEventListener('dblclick', () => window.open(googleUrl, '_blank'));
    });

    if (allMarkers.length > 0) {
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
    }
});
</script>
{% endblock %}
